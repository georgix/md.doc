DNS over HTTPs
================

- date: 23/08/2019
- OS: ubuntu 18.04

## disable systemd-resolved

    sudo systemctl disable systemd-resolved
    sudo systemctl stop systemd-resolved

## disable DNS server in connmand

If you are running a local DNS server, it will likely have problems binding to port 53 (TCP and/or UDP) after installing Connman. This is because Connman includes its own DNS proxy which also tries to bind to those ports. If you see log messages from BIND or dnsmasq like

"named[529]: could not listen on UDP socket: address in use"
this could be the problem. To verify which application is listening on the ports, you can execute ss -tulpn as root.

To fix this connmand can be started with the options -r or --nodnsproxy by overriding the systemd service file. Create the folder /etc/systemd/system/connman.service.d/ and add the file disable_dns_proxy.conf:

/etc/systemd/system/connman.service.d/disable_dns_proxy.conf

    [Service]
    ExecStart=
    ExecStart=/usr/bin/connmand -n --nodnsproxy

    sudo systemctl daemon-reload
    sudo systemctl reload-or-restart connman

## setup dnsmasq


    $ cat /etc/dnsmasq.d/dnss.conf
    no-resolv

    listen-address=127.0.0.1

    server=127.0.0.1#5053
    server=/garmin.com/192.168.249.2

    sudo systemctl reload-or-restart dnsmasq
    ss -tulpn | grep 53

    $ cat /etc/dnsmasq.conf
    # Include all files in a directory which end in .conf
    conf-dir=/etc/dnsmasq.d/,*.conf

    sudo systemctl daemon-reload
    sudo systemctl restart dnsmasq

##  DNS over HTTPS

[google public DNS](https://developers.google.com/speed/public-dns/docs/doh/)
[Google DNS web](https://dns.google/)

- dnss
- https_dns_proxy
- dnscrypt-proxy

## setup dnss

    $ dnss -h
    $ sudo cat /lib/systemd/system/dnss.socket
    
    # Sockets for dnss.
    #
    # This lets dnss run unprivileged.
    # We typically want one UDP and one TCP socket.

    [Socket]
    #ListenDatagram=53
    #ListenStream=53
    ListenDatagram=127.0.0.1:5053
    ListenStream=127.0.0.1:5053

    [Install]
    WantedBy=sockets.target

    $sudo systemctl daemon-reload
    $sudo systemctl restart dnss

## /etc/resolv

    $ cat /etc/resolv.conf
    # Generated by Connection Manager
    search localdomain

    nameserver 127.0.0.1
    nameserver 192.168.249.2

## test DNS
    $ dig A clients3.google.com @127.0.0.1

    $ journalctl -xe
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTgwMzQwMDY4OV19
-->